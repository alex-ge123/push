<!DOCTYPE html>
<html>
<head>
  <title>WebSocket demo</title>
  <meta name="content-type" content="text/html" charset="UTF-8">
</head>
<body>
<div>消息展示</div>
<hr>
<div>
  <div id="response"></div>
</div>

<script>
  // 禁用WebSocket
  // window.WebSocket = null;
</script>
<script src="https://libs.cdnjs.net/jquery/3.4.1/jquery.min.js"></script>
<script src="https://libs.cdnjs.net/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://libs.cdnjs.net/stomp.js/2.3.3/stomp.min.js"></script>
<script>
  //加载完浏览器后  调用connect()，打开双通道
  $(function () {
    //打开双通道
    connect()
  })

  //强制关闭浏览器  调用websocket.close(),进行正常关闭
  window.onunload = function () {
    disconnect()
  }

  function connect() {
    var socket = new SockJS('http://localhost:5200/ws'); //连接SockJS的endpoint名称为"ws"
    stompClient = Stomp.over(socket); //使用STMOP子协议的WebSocket客户端
    stompClient.heartbeat.outgoing = 20000; //客户端每20000ms发送一次心跳检测
    stompClient.heartbeat.incoming = 20000; //客户端不从服务端接收心跳包
    var headers = {
      'token': '05d180d5-7e80-4d2f-9ac4-f74ec7fdeb61',
      'product': 'map',
      'terminal': 'DSM',
      'clientId': 'DSM002'
    };
    stompClient.connect(headers, connectCallback, errorCallback);
  }

  //连接WebSocket服务端回调函数
  function connectCallback(frame) {
    console.log('Connected:' + frame);
    //通过stompClient.subscribe订阅/topic/all 目标(destination)发送的消息
    stompClient.subscribe('/topic/to-all', function (response) {
      showResponse(response.body);
      // showResponse(JSON.parse(response.body));
    });
    // 产品_租户id_对象id
    stompClient.subscribe('/user/map_DSM_DSM001/to-user', function (response) {
      showResponse(response.body);
      // showResponse(JSON.parse(response.body));
    });
  }

  //连接失败时的回调函数，此函数重新调用连接方法，形成循环，直到连接成功
  function errorCallback() {
    connect();
  }

  //关闭双通道
  function disconnect() {
    if (stompClient != null) {
      stompClient.disconnect();
    }
    console.log("Disconnected");
  }

  function showResponse(message) {
    var response = $("#response");
    response.append("<div>" + message + "</div>&nbsp;&nbsp;&nbsp;&nbsp;");
  }
</script>
</body>
</html>
